<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenDNS</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-color: #f4f4f4;
            --text-color: #333;
            --container-bg: white;
            --border-color: #ddd;
            --record-type-bg: #e9ecef;
            --record-bg: #f8f9fa;
            --record-border: #28a745;
            --error-color: red;
            --loading-color: #666;
            --tooltip-bg: #333;
            --tooltip-border: #555;
            --tooltip-text: white;
            --new-record-bg: #d4edda;
            --modified-record-bg: #fff3cd;
            --removed-record-bg: #f8d7da;
        }
        [data-theme="dark"] {
            --bg-color: #222;
            --text-color: #e0e0e0;
            --container-bg: #333;
            --border-color: #555;
            --record-type-bg: #444;
            --record-bg: #3a3a3a;
            --record-border: #34c759;
            --error-color: #ff5555;
            --loading-color: #aaa;
            --tooltip-bg: #111;
            --tooltip-border: #666;
            --tooltip-text: #e0e0e0;
            --new-record-bg: #2e7d32;
            --modified-record-bg: #ffca28;
            --removed-record-bg: #d32f2f;
        }
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        h1 {
            text-align: center;
        }
        p.intro {
            color: var(--text-color);
            font-size: 14px;
            margin: 0;
        }
        .input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #domain {
            flex-grow: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--container-bg);
            color: var(--text-color);
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        button:hover {
            background-color: #218838;
        }
        .copy-btn {
            padding: 5px 10px;
            font-size: 14px;
            background-color: #007bff;
            margin-left: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .copy-btn:hover {
            background-color: #0056b3;
        }
        #export-btn, #history-btn, #clear-history-btn {
            background-color: #ff9500;
            margin-top: 10px;
            display: none;
            margin-right: 10px;
        }
        #export-btn:hover, #history-btn:hover, #clear-history-btn:hover {
            background-color: #e68a00;
        }
        #theme-toggle {
            background-color: #666;
            position: absolute;
            top: 20px;
            right: 20px;
        }
        #theme-toggle:hover {
            background-color: #555;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--container-bg);
            border-radius: 4px;
            border: 1px solid var(--border-color);
            min-height: 100px;
        }
        .loading {
            display: none;
            text-align: center;
            font-style: italic;
            color: var(--loading-color);
        }
        .error {
            color: var(--error-color);
        }
        .record-type {
            margin-top: 20px;
            padding: 10px;
            background-color: var(--record-type-bg);
            border-radius: 4px;
        }
        .record-type h3 {
            margin: 0 0 10px 0;
            color: var(--text-color);
            cursor: help;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .record {
            margin: 10px 0;
            padding: 10px;
            border-left: 3px solid var(--record-border);
            background-color: var(--record-bg);
            position: relative;
        }
        .record.new {
            background-color: var(--new-record-bg);
        }
        .record.modified {
            background-color: var(--modified-record-bg);
        }
        .record.removed {
            background-color: var(--removed-record-bg);
            opacity: 0.7;
        }
        .change-indicator {
            font-size: 12px;
            font-style: italic;
            margin-top: 5px;
            color: var(--text-color);
        }
        .data-container {
            display: flex;
            align-items: center;
        }
        .ui-tooltip {
            max-width: 300px;
            font-size: 12px;
            background-color: var(--tooltip-bg);
            color: var(--tooltip-text);
            border: 1px solid var(--tooltip-border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            padding: 8px;
        }
        .ui-dialog {
            background-color: var(--container-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .ui-dialog-titlebar {
            background-color: var(--record-type-bg);
            color: var(--text-color);
        }
        .history-entry {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .history-entry h4 {
            margin: 0 0 10px 0;
            color: var(--text-color);
        }
        .fa-spin {
            animation: fa-spin 2s infinite linear;
        }
    </style>
</head>
<body data-theme="light">
    <button id="theme-toggle" onclick="toggleTheme()"><i class="fas fa-sun"></i> Light Mode</button>
    <h1><i class="fas fa-globe"></i> OpenDNS</h1>
    <div class="input-container">
        <input type="text" id="domain" placeholder="Enter domain (e.g., example.com)">
        <button onclick="performLookup()"><i class="fas fa-search"></i> Lookup</button>
    </div>
    <div id="loading" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
    <div style="display: flex; gap: 10px;">
        <button id="export-btn" onclick="exportRecords()"><i class="fas fa-download"></i> Export DNS Records</button>
        <button id="history-btn" onclick="showHistory()"><i class="fas fa-history"></i> View DNS History</button>
        <button id="clear-history-btn" onclick="clearAllHistory()"><i class="fas fa-trash"></i> Clear All History</button>
    </div>
    <div id="results">
        <p class="intro">Enter a domain name (e.g., example.com) to view its DNS records, including IP addresses, mail servers, name servers, and more. Hover over record type headings for explanations.</p>
    </div>
    <div id="history-dialog" style="display: none;"></div>

    <script>
        // Initialize jQuery UI tooltips and dialog
        $(document).ready(function() {
            $(document).tooltip({
                items: "[data-tooltip]",
                content: function() {
                    const recordType = $(this).attr('data-tooltip');
                    const tooltips = {
                        'A': 'A (Address) records map a domain to an IPv4 address (e.g., 192.0.2.1). They are used to locate the server hosting a website or service.',
                        'AAAA': 'AAAA (IPv6 Address) records map a domain to an IPv6 address (e.g., 2001:db8::1). They are used for newer, larger IP address formats.',
                        'CNAME': 'CNAME (Canonical Name) records alias one domain to another. They point to another domain name rather than an IP address (e.g., www.example.com to example.com).',
                        'MX': 'MX (Mail Exchange) records specify the mail servers responsible for receiving email for a domain (e.g., mail.example.com). They include a priority value.',
                        'NS': 'NS (Name Server) records indicate which name servers are authoritative for a domain. They list the servers managing the domainâ€™s DNS records.',
                        'TXT': 'TXT (Text) records store arbitrary text data, often used for verification (e.g., SPF, DKIM) or configuration settings for services.'
                    };
                    return tooltips[recordType] || 'No description available.';
                }
            });

            // Initialize history dialog
            $('#history-dialog').dialog({
                autoOpen: false,
                modal: true,
                width: 600,
                title: 'DNS Lookup History',
                buttons: {
                    Close: function() {
                        $(this).dialog('close');
                    }
                }
            });

            // Check for existing history on page load
            const domain = $('#domain').val().trim();
            if (domain && localStorage.getItem(`dns_history_${domain}`)) {
                $('#history-btn').show();
                $('#clear-history-btn').show();
            }
        });

        // Theme toggle function
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            const isLightMode = body.getAttribute('data-theme') === 'light';
            if (isLightMode) {
                body.setAttribute('data-theme', 'dark');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
            } else {
                body.setAttribute('data-theme', 'light');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            }
        }

        let dnsRecords = {}; // Store current DNS records for export

        function performLookup() {
            const domain = $('#domain').val().trim();
            const resultsDiv = $('#results');
            const loadingDiv = $('#loading');
            const exportBtn = $('#export-btn');
            const historyBtn = $('#history-btn');
            const clearHistoryBtn = $('#clear-history-btn');
            const recordTypes = ['A', 'AAAA', 'CNAME', 'MX', 'NS', 'TXT'].sort(); // Sort alphabetically

            // Clear previous results and hide buttons
            resultsDiv.empty();
            exportBtn.hide();
            historyBtn.hide();
            clearHistoryBtn.hide();
            dnsRecords = {}; // Reset current records
            loadingDiv.show();

            // Input validation
            if (!domain) {
                resultsDiv.html('<p class="error"><i class="fas fa-exclamation-circle"></i> Please enter a valid domain name.</p>');
                loadingDiv.hide();
                return;
            }

            // Load history from local storage
            const historyKey = `dns_history_${domain}`;
            const history = JSON.parse(localStorage.getItem(historyKey)) || [];
            const previousRecords = history.length > 0 ? history[history.length - 1].records : {};

            // Show history button if history exists
            if (history.length > 0) {
                historyBtn.show();
                clearHistoryBtn.show();
            }

            // Track completed requests
            let completedRequests = 0;
            const totalRequests = recordTypes.length;

            // Function to check if all requests are done
            function checkAllDone() {
                completedRequests++;
                if (completedRequests === totalRequests) {
                    // Save current records to history
                    history.push({
                        timestamp: new Date().toISOString(),
                        records: dnsRecords
                    });
                    localStorage.setItem(historyKey, JSON.stringify(history));
                    loadingDiv.hide();
                    if (resultsDiv.is(':empty')) {
                        resultsDiv.html('<p><i class="fas fa-info-circle"></i> No records found for this query.</p>');
                    } else {
                        exportBtn.show();
                        historyBtn.show();
                        clearHistoryBtn.show();
                    }
                }
            }

            // Compare records to detect changes
            function compareRecords(current, previous) {
                if (!previous) return { status: 'new', details: 'New record' };
                if (JSON.stringify(current) === JSON.stringify(previous)) return { status: 'unchanged', details: '' };
                return { status: 'modified', details: 'Record modified since last lookup' };
            }

            // Query each record type
            recordTypes.forEach(recordType => {
                const url = `https://dns.google/resolve?name=${encodeURIComponent(domain)}&type=${recordType}`;
                const iconMap = {
                    'A': 'fa-server',
                    'AAAA': 'fa-network-wired',
                    'CNAME': 'fa-link',
                    'MX': 'fa-envelope',
                    'NS': 'fa-sitemap',
                    'TXT': 'fa-file-alt'
                };

                $.ajax({
                    url: url,
                    method: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        if (data.Answer) {
                            dnsRecords[recordType] = data.Answer; // Store current records
                            let html = `<div class="record-type"><h3 data-tooltip="${recordType}"><i class="fas ${iconMap[recordType]}"></i> ${recordType} Records</h3>`;
                            data.Answer.forEach((answer, index) => {
                                const previousAnswer = previousRecords[recordType] ? previousRecords[recordType].find(p => p.name === answer.name && p.type === answer.type) : null;
                                const comparison = compareRecords(answer, previousAnswer);
                                const changeClass = comparison.status; // new, modified, or unchanged
                                const changeDetails = comparison.details ? `<div class="change-indicator">${comparison.details}</div>` : '';
                                html += `
                                    <div class="record ${changeClass}">
                                        <strong>Name:</strong> ${answer.name}<br>
                                        <strong>Type:</strong> ${answer.type}<br>
                                        <strong>TTL:</strong> ${answer.TTL}<br>
                                        <div class="data-container">
                                            <strong>Data:</strong> <span id="data-${recordType}-${index}">${answer.data}</span>
                                            <button class="copy-btn" onclick="copyToClipboard('data-${recordType}-${index}')"><i class="fas fa-copy"></i> Copy</button>
                                        </div>
                                        ${changeDetails}
                                    </div>`;
                            });
                            // Check for removed records
                            if (previousRecords[recordType]) {
                                previousRecords[recordType].forEach(prev => {
                                    if (!data.Answer.find(curr => curr.name === prev.name && curr.type === prev.type)) {
                                        html += `
                                            <div class="record removed">
                                                <strong>Name:</strong> ${prev.name}<br>
                                                <strong>Type:</strong> ${prev.type}<br>
                                                <strong>TTL:</strong> ${prev.TTL}<br>
                                                <div class="data-container">
                                                    <strong>Data:</strong> <span>${prev.data}</span>
                                                </div>
                                                <div class="change-indicator">Record removed since last lookup</div>
                                            </div>`;
                                    }
                                });
                            }
                            html += `</div>`;
                            resultsDiv.append(html);
                        }
                        checkAllDone();
                    },
                    error: function() {
                        checkAllDone();
                    }
                });
            });
        }

        // Clear all DNS history from local storage
        function clearAllHistory() {
            if (confirm('Are you sure you want to clear all DNS lookup history for all domains?')) {
                // Remove all keys starting with 'dns_history_'
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('dns_history_')) {
                        localStorage.removeItem(key);
                    }
                });
                $('#history-btn').hide();
                $('#clear-history-btn').hide();
                $('#history-dialog').dialog('close').empty().html('<p>No lookup history found.</p>');
                alert('All DNS lookup history has been cleared.');
                // Refresh current results to show all as new
                if (Object.keys(dnsRecords).length > 0) {
                    performLookup();
                }
            }
        }

        // Show DNS history in a modal dialog
        function showHistory() {
            const domain = $('#domain').val().trim();
            const historyKey = `dns_history_${domain}`;
            const history = JSON.parse(localStorage.getItem(historyKey)) || [];
            const historyDiv = $('#history-dialog');
            historyDiv.empty();

            if (history.length === 0) {
                historyDiv.html('<p>No lookup history found for this domain.</p>');
            } else {
                history.forEach((entry, index) => {
                    const timestamp = new Date(entry.timestamp).toLocaleString();
                    let html = `<div class="history-entry"><h4>Lookup at ${timestamp}</h4>`;
                    const recordTypes = Object.keys(entry.records).sort();
                    recordTypes.forEach(recordType => {
                        const iconMap = {
                            'A': 'fa-server',
                            'AAAA': 'fa-network-wired',
                            'CNAME': 'fa-link',
                            'MX': 'fa-envelope',
                            'NS': 'fa-sitemap',
                            'TXT': 'fa-file-alt'
                        };
                        html += `<div class="record-type"><h3><i class="fas ${iconMap[recordType]}"></i> ${recordType} Records</h3>`;
                        const previousRecords = index > 0 ? history[index - 1].records : {};
                        entry.records[recordType].forEach((record, recordIndex) => {
                            const previousAnswer = previousRecords[recordType] ? previousRecords[recordType].find(p => p.name === record.name && p.type === record.type) : null;
                            const comparison = compareRecords(record, previousAnswer);
                            const changeClass = comparison.status;
                            const changeDetails = comparison.details ? `<div class="change-indicator">${comparison.details}</div>` : '';
                            html += `
                                <div class="record ${changeClass}">
                                    <strong>Name:</strong> ${record.name}<br>
                                    <strong>Type:</strong> ${record.type}<br>
                                    <strong>TTL:</strong> ${record.TTL}<br>
                                    <div class="data-container">
                                        <strong>Data:</strong> <span id="history-data-${recordType}-${recordIndex}-${index}">${record.data}</span>
                                        <button class="copy-btn" onclick="copyToClipboard('history-data-${recordType}-${recordIndex}-${index}')"><i class="fas fa-copy"></i> Copy</button>
                                    </div>
                                    ${changeDetails}
                                </div>`;
                        });
                        // Check for removed records in history
                        if (previousRecords[recordType] && index > 0) {
                            previousRecords[recordType].forEach(prev => {
                                if (!entry.records[recordType].find(curr => curr.name === prev.name && curr.type === prev.type)) {
                                    html += `
                                        <div class="record removed">
                                            <strong>Name:</strong> ${prev.name}<br>
                                            <strong>Type:</strong> ${prev.type}<br>
                                            <strong>TTL:</strong> ${prev.TTL}<br>
                                            <div class="data-container">
                                                <strong>Data:</strong> <span>${prev.data}</span>
                                            </div>
                                            <div class="change-indicator">Record removed since previous lookup</div>
                                        </div>`;
                                }
                            });
                        }
                        html += `</div>`;
                    });
                    html += `</div>`;
                    historyDiv.append(html);
                });
            }
            $('#history-dialog').dialog('open');
        }

        // Compare records to detect changes
        function compareRecords(current, previous) {
            if (!previous) return { status: 'new', details: 'New record' };
            if (JSON.stringify(current) === JSON.stringify(previous)) return { status: 'unchanged', details: '' };
            return { status: 'modified', details: 'Record modified since last lookup' };
        }

        // Export DNS records as JSON
        function exportRecords() {
            const domain = $('#domain').val().trim();
            const exportData = {
                domain: domain,
                timestamp: new Date().toISOString(),
                records: dnsRecords
            };
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${domain}_dns_records.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Copy to clipboard function with fallback
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;

            // Try using Clipboard API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Copied to clipboard: ' + text);
                }).catch(err => {
                    console.error('Clipboard API failed: ', err);
                    fallbackCopyToClipboard(text);
                });
            } else {
                // Fallback for non-secure contexts or unsupported browsers
                fallbackCopyToClipboard(text);
            }
        }

        // Fallback copy function using textarea
        function fallbackCopyToClipboard(text) {
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed'; // Prevent scrolling
                textarea.style.opacity = '0'; // Make invisible
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Copied to clipboard: ' + text);
            } catch (err) {
                console.error('Fallback copy failed: ', err);
                alert('Failed to copy to clipboard.');
            }
        }

        // Trigger lookup on Enter key press
        $('#domain').on('keypress', function(e) {
            if (e.which === 13) {
                performLookup();
            }
        });
    </script>
</body>
</html>
